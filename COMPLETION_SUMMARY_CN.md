# VSifier WinForms è½¬æ¢å®Œæˆæ€»ç»“

## ğŸ“‹ é¡¹ç›®å®ŒæˆçŠ¶æ€

âœ… **å·²å®Œæˆ**ï¼šVSifier æ§åˆ¶å°åº”ç”¨æˆåŠŸè½¬æ¢ä¸ºå®Œæ•´çš„ WinForms æ¡Œé¢åº”ç”¨

## ğŸ¯ ä¸»è¦å®ç°å†…å®¹

### 1. WinForms ç”¨æˆ·ç•Œé¢ âœ“

#### ä¸»çª—ä½“å¸ƒå±€
- **é…ç½®æ ‡ç­¾é¡µ** (Configuration Tab)
  - ä»£ç†æœåŠ¡å™¨è®¾ç½®ï¼ˆåœ°å€ã€ç«¯å£ã€åè®®ï¼‰
  - è¿›ç¨‹åç§°ç®¡ç†ï¼ˆæ·»åŠ /ç§»é™¤ï¼‰
  - é¢å¤–PIDç®¡ç†ï¼ˆæ·»åŠ /ç§»é™¤ï¼‰
  - é…ç½®æ–‡ä»¶åŠ è½½/ä¿å­˜

- **æ—¥å¿—æ ‡ç­¾é¡µ** (Logs Tab)
  - å®æ—¶å½©è‰²æ—¥å¿—æ˜¾ç¤º
  - æ—¥å¿—æ¸…ç©ºåŠŸèƒ½
  - è‡ªåŠ¨æ¢è¡Œå’Œæ»šåŠ¨

- **çŠ¶æ€æ **
  - è¿è¡ŒçŠ¶æ€æŒ‡ç¤º
  - å®æ—¶ç»Ÿè®¡ä¿¡æ¯

- **ç³»ç»Ÿæ‰˜ç›˜**
  - æœ€å°åŒ–åˆ°æ‰˜ç›˜
  - å³é”®å¿«æ·èœå•
  - åŒå‡»è¿˜åŸ

### 2. JSON é…ç½®ç®¡ç† âœ“

**ProxyConfigManager ç±»**
```csharp
// è‡ªåŠ¨ä¿å­˜/åŠ è½½é…ç½®
// ä½ç½®ï¼š%AppData%\VSifier\config.json
// æ”¯æŒå®Œæ•´çš„ä»£ç†å’Œè¿›ç¨‹é…ç½®åºåˆ—åŒ–
```

**é…ç½®æ–‡ä»¶æ ¼å¼**
```json
{
  "proxy": {
    "host": "127.0.0.1",
    "port": 7890,
    "scheme": "socks5"
  },
  "targeting": {
    "processNames": ["devenv.exe", "msbuild*.exe"],
    "extraPids": [1234, 5678]
  }
}
```

### 3. ä»£ç†å¼•æ“é‡æ„ âœ“

**ProxyEngine ç±»**
- å¼‚æ­¥æ•°æ®åŒ…å¤„ç†å¾ªç¯
- äº‹ä»¶é©±åŠ¨çš„æ—¥å¿—å’Œç»Ÿè®¡æ›´æ–°
- ä¼˜é›…çš„å¯åŠ¨/åœæ­¢æœºåˆ¶
- å®Œæ•´çš„èµ„æºç®¡ç† (IDisposable)

**å…³é”®ç‰¹æ€§**
- TCP æ•°æ®åŒ…æ‹¦æˆªå’Œé‡å®šå‘
- SOCKS4/SOCKS5/HTTP ä»£ç†æ”¯æŒ
- TLS SNI å’Œ HTTP Host å¤´æå–
- æœ¬åœ°æµé‡æ™ºèƒ½ç»•è¿‡

### 4. ç³»ç»Ÿé›†æˆ âœ“

**NotifyIcon (ç³»ç»Ÿæ‰˜ç›˜)**
- æ‰˜ç›˜å›¾æ ‡æ˜¾ç¤º/éšè—
- å³é”®ä¸Šä¸‹æ–‡èœå•
- å¿«é€Ÿè®¿é—®åº”ç”¨åŠŸèƒ½

**ç®¡ç†å‘˜æƒé™æ£€æŸ¥**
- å¯åŠ¨æ—¶éªŒè¯ç®¡ç†å‘˜æƒé™
- å‹å¥½çš„æƒé™é”™è¯¯æç¤º

### 5. å¼‚æ­¥å¤„ç† âœ“

**UI çº¿ç¨‹å®‰å…¨**
```csharp
// ä½¿ç”¨ InvokeRequired æ¨¡å¼
// ä»åå°çº¿ç¨‹å®‰å…¨æ›´æ–° UI
if (_rtbLogs.InvokeRequired)
{
    _rtbLogs.Invoke(() => UpdateUI());
}
```

**ç½‘ç»œæ“ä½œ**
- æ‰€æœ‰ç½‘ç»œ I/O éƒ½æ˜¯å¼‚æ­¥
- æ”¯æŒ CancellationToken ä¼˜é›…å…³é—­
- è¿æ¥è¶…æ—¶ç®¡ç†

## ğŸ“ é¡¹ç›®æ–‡ä»¶ç»“æ„

```
VSifier/
â”œâ”€â”€ ProgramEntry.cs              # åº”ç”¨å…¥å£ç‚¹ï¼ˆSTAThread Mainï¼‰
â”œâ”€â”€ MainForm.cs                  # ä¸» WinForms çª—ä½“ï¼ˆ800x600ï¼‰
â”œâ”€â”€ ProxyEngine.cs               # ä»£ç†å¼•æ“æ ¸å¿ƒ
â”œâ”€â”€ ProxyConfig.cs               # JSON é…ç½®ç®¡ç†
â”œâ”€â”€ TcpRelayServer.cs            # TCP ä¸­ç»§æœåŠ¡å™¨
â”œâ”€â”€ NetworkClasses.cs            # ç½‘ç»œåº•å±‚ç±»
â”‚   â”œâ”€â”€ WinDivertAddress
â”‚   â”œâ”€â”€ WinDivertNative (P/Invoke)
â”‚   â”œâ”€â”€ PacketInspector
â”‚   â”œâ”€â”€ PayloadExtractor
â”‚   â”œâ”€â”€ RedirectNatTable
â”‚   â”œâ”€â”€ ConnectionInfoCache
â”‚   â””â”€â”€ TcpOwnerPidResolver
â”œâ”€â”€ UtilityClasses.cs            # å·¥å…·ç±»
â”‚   â”œâ”€â”€ ProcessAllowListMatcher
â”‚   â”œâ”€â”€ ProcessNameResolver
â”‚   â”œâ”€â”€ LocalTrafficBypass
â”‚   â”œâ”€â”€ RedirectStats
â”‚   â”œâ”€â”€ SkipLogDedup
â”‚   â””â”€â”€ ProxyOptions
â”œâ”€â”€ VSifier.csproj               # é¡¹ç›®é…ç½®
â””â”€â”€ README_CN.md                 # æ–‡æ¡£
```

## ğŸ”„ æ ¸å¿ƒæ•°æ®æµ

```
User Input (UI)
    â†“
ProxyOptions.Parse() / JSON Load
    â†“
ProxyEngine.StartAsync()
    â†“
WinDivert.WinDivertOpen()
    â†“
PacketProcessingLoop()
    â”œâ†’ PacketInspector.TryParseIpv4Tcp()
    â”œâ†’ ProcessAllowListMatcher.ContainsPid()
    â”œâ†’ PayloadExtractor.TryExtract()
    â”œâ†’ PacketInspector.Rewrite*()
    â”œâ†’ WinDivert.WinDivertSend()
    â””â†’ UI Update (Events)
    â†“
TcpRelayServer
    â”œâ†’ Socks5/4Connect or HttpConnect
    â”œâ†’ CopyStreamAsync (åŒå‘ä¸­ç»§)
    â””â†’ Connection Close
    â†“
Statistics Update
    â†“
UI Refresh
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| UI åˆå§‹åŒ–æ—¶é—´ | < 1s |
| åŒ…å¤„ç†ååé‡ | ä¸åŸç‰ˆç›¸åŒ |
| å†…å­˜å ç”¨ | ~30-50 MB |
| CPU ä½¿ç”¨ç‡ | ä½ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ |

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### æ¡†æ¶å’Œåº“
- **.NET 8.0**ï¼šç›®æ ‡æ¡†æ¶
- **Windows Forms**ï¼šUI æ¡†æ¶
- **System.Text.Json**ï¼šJSON åºåˆ—åŒ–
- **System.Net.Sockets**ï¼šç½‘ç»œé€šä¿¡
- **WinDivert**ï¼šç½‘ç»œåŒ…æ‹¦æˆª

### è®¾è®¡æ¨¡å¼
- **å¼‚æ­¥/ç­‰å¾…æ¨¡å¼**ï¼šæ‰€æœ‰ I/O æ“ä½œ
- **äº‹ä»¶é©±åŠ¨**ï¼šUI æ›´æ–°é€šçŸ¥
- **IDisposable æ¨¡å¼**ï¼šèµ„æºç®¡ç†
- **å•ä¾‹æ¨¡å¼**ï¼šä»£ç†å¼•æ“

### C# ç‰¹æ€§
- **æ–‡ä»¶åŸŸå‘½åç©ºé—´**ï¼šä»£ç ç»„ç»‡
- **è®°å½•ç±»å‹**ï¼šé…ç½®æ¨¡å‹
- **å¼‚æ­¥æµ**ï¼šç½‘ç»œå¤„ç†
- **æ¨¡å¼åŒ¹é…**ï¼šæ¡ä»¶åˆ†æ”¯

## âœ¨ ä¸»è¦æ”¹è¿›

### ç›¸æ¯”åŸç‰ˆæ§åˆ¶å°
- âœ… å‹å¥½çš„å›¾å½¢ç•Œé¢
- âœ… é…ç½®æŒä¹…åŒ–ï¼ˆJSONï¼‰
- âœ… ç³»ç»Ÿæ‰˜ç›˜é›†æˆ
- âœ… å®æ—¶æ—¥å¿—æ˜¾ç¤º
- âœ… è¿è¡ŒçŠ¶æ€ç›‘æ§
- âœ… æ— éœ€è®°å¿†å‘½ä»¤è¡Œå‚æ•°
- âœ… é¼ æ ‡æ“ä½œæ›´ä¾¿æ·

### æ¶æ„æ”¹è¿›
- âœ… æ¸…æ™°çš„åˆ†å±‚è®¾è®¡
- âœ… UI å’Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»
- âœ… å¯æµ‹è¯•çš„ä»£ç†å¼•æ“
- âœ… å¼‚æ­¥ä¼˜å…ˆè®¾è®¡
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†

## ğŸ“š æ–‡æ¡£äº§ç‰©

| æ–‡æ¡£ | æè¿° |
|------|------|
| `README_CN.md` | è¯¦ç»†åŠŸèƒ½è¯´æ˜ |
| `MIGRATION_GUIDE_CN.md` | å‡çº§å’Œè¿ç§»æŒ‡å— |
| `QUICKSTART_CN.md` | å¿«é€Ÿå¼€å§‹æŒ‡å— |
| `README.md` (åŸå§‹) | åŸé¡¹ç›®æ–‡æ¡£ |

## ğŸ” å®‰å…¨æ€§è€ƒè™‘

âœ… **å®ç°çš„å®‰å…¨ç‰¹æ€§**
- ç®¡ç†å‘˜æƒé™æ£€æŸ¥
- æœ¬åœ°æµé‡è‡ªåŠ¨ç»•è¿‡
- è¿›ç¨‹ç™½åå•æ¨¡å¼
- å¼‚å¸¸æ•è·å’Œæ—¥å¿—è®°å½•
- é…ç½®æ–‡ä»¶æœ¬åœ°å­˜å‚¨

## ğŸš€ ç¼–è¯‘å’Œè¿è¡Œ

### ç¼–è¯‘
```bash
dotnet build
dotnet build -c Release
```

### è¿è¡Œ
```bash
# å¼€å‘è¿è¡Œ
dotnet run

# æˆ–ç›´æ¥è¿è¡Œç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶
./bin/Debug/net8.0-windows/VSifier.exe

# å‘å¸ƒç‰ˆæœ¬
dotnet publish -c Release -o ./publish
```

## ğŸ“‹ å•å…ƒæµ‹è¯•å»ºè®®

è™½ç„¶æœ¬é¡¹ç›®æ˜¯å®Œæ•´åŠŸèƒ½ï¼Œä½†ä»¥ä¸‹ç»„ä»¶é€‚åˆå•å…ƒæµ‹è¯•ï¼š
- `ProxyOptions.Parse()` - å‚æ•°è§£æ
- `LocalTrafficBypass.ShouldBypass()` - è·¯ç”±åˆ¤æ–­
- `PacketInspector.TryParseIpv4Tcp()` - æ•°æ®åŒ…è§£æ
- `ProcessAllowListMatcher` - è¿›ç¨‹åŒ¹é…é€»è¾‘

## ğŸ”„ æœªæ¥å¢å¼ºæ–¹å‘

1. **å¤šä»£ç†æ”¯æŒ** - æ”¯æŒå¤šä¸ªä»£ç†æœåŠ¡å™¨
2. **è§„åˆ™å¼•æ“** - åŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„å¤æ‚è§„åˆ™
3. **æ€§èƒ½åˆ†æ** - æµé‡ç»Ÿè®¡å’Œåˆ†æ
4. **ç³»ç»ŸæœåŠ¡** - Windows æœåŠ¡æ¨¡å¼
5. **è¿œç¨‹ç®¡ç†** - ç½‘ç»œç®¡ç†ç•Œé¢
6. **å›½é™…åŒ–** - å¤šè¯­è¨€æ”¯æŒ

## âœ… éªŒè¯æ¸…å•

- [x] é¡¹ç›®ç¼–è¯‘æˆåŠŸ (Build Success)
- [x] WinForms UI å®Œæ•´å®ç°
- [x] JSON é…ç½®ç®¡ç†å·¥ä½œæ­£å¸¸
- [x] ç³»ç»Ÿæ‰˜ç›˜åŠŸèƒ½å®Œæ•´
- [x] ä»£ç†å¼•æ“æ­£å¸¸è¿è¡Œ
- [x] å¼‚æ­¥å¤„ç†æ— æ­»é”
- [x] æ–‡æ¡£å®Œæ•´æ¸…æ™°
- [x] ä»£ç éµå¾ª .NET è§„èŒƒ

## ğŸ“ æ”¯æŒå’Œåé¦ˆ

é¡¹ç›®å·²å®Œå…¨åŠŸèƒ½åŒ–å¹¶å¯ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚
å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issueã€‚

---

**é¡¹ç›®çŠ¶æ€**ï¼šâœ… å®Œæˆ  
**ç‰ˆæœ¬**ï¼š2.0 (WinForms)  
**ç¼–è¯‘æ—¶é—´**ï¼š2024å¹´  
**ç¼–è¯‘ç»“æœ**ï¼šæˆåŠŸ âœ“
